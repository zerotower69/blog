{"version":3,"file":"index.js","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":"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","sourcesContent":["import type { BytemdAction, BytemdPlugin } from \"bytemd\";\nimport en from \"../locales/en.json\";\nimport yaml from \"js-yaml\";\n\nconst ICON_SVG = `<svg width=\"24\" height=\"24\" viewBox=\"0 0 48 48\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n<rect width=\"48\" height=\"48\" fill=\"white\" fill-opacity=\"0.01\"></rect>\n<path d=\"M6 44L6 25H12V17H36V25H42V44H6Z\" fill=\"none\" stroke=\"#333\" stroke-width=\"4\" stroke-linejoin=\"round\"></path>\n<path d=\"M17 17V8L31 4V17\" stroke=\"#333\" stroke-width=\"4\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></path>\n</svg>`;\n\ntype Locale = {\n  title: string;\n};\n\nexport interface BytemdPluginSwitchHighlightOptions {\n  /**\n   * using inline svg\n   */\n  icon?: string;\n  /**\n   * highlight key in your formatter, default: theme\n   */\n  highlightKey?: string;\n  /**\n   * you can use different languages for as you like!\n   */\n  locale?: string;\n  /**\n   * using cdn highlight styles:\n   * jsdeliver\n   */\n  cdn?: string[];\n  highlights?: string[];\n}\nexport default function switchHighlight(options: BytemdPluginSwitchHighlightOptions = {}): BytemdPlugin {\n  //默认参数构建\n  const CDN = options?.cdn ?? [];\n  //兜底CDN\n  CDN.push(\"https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles\");\n  const locale = (options?.locale ?? en) as Locale;\n  const HIGHLIGHTS = options?.highlights ?? [\"vs\", \"one-light\", \"a11y-dark\", \"agate\", \"arta\", \"idea\"];\n  const HIGHLIGHT_KEY = \"highlight\";\n  const icon = options?.icon ?? ICON_SVG;\n\n  //自动加载\n  let $linkEl: HTMLLinkElement;\n  let count = 0;\n  let style = \"vs\";\n  function loadStyle() {\n    //TODO:已经加载的不要再加载了\n    if (count + 1 > CDN.length || style === undefined) {\n      return;\n    }\n    const $header = document.getElementsByTagName(\"head\")[0];\n    $linkEl = document.createElement(\"link\");\n    $linkEl.rel = \"stylesheet\";\n    const baseLink = CDN[count];\n    $linkEl.href = `${baseLink}${baseLink.endsWith(\"/\") ? \"\" : \"/\"}${style}.min.css`;\n    $header.appendChild($linkEl);\n    $linkEl.onerror = function () {\n      //when load error, load left cdns.\n      if (count + 1 > (options.cdn?.length ?? 0)) {\n        return;\n      }\n      count++;\n      $linkEl?.remove();\n      $linkEl = document.createElement(\"link\");\n      $linkEl.rel = \"stylesheet\";\n      const baseLink = CDN[count];\n      $linkEl.href = `${baseLink}${baseLink.endsWith(\"/\") ? \"\" : \"/\"}${style}.min.css`;\n      $header.appendChild($linkEl);\n    };\n  }\n\n  const actionItems = HIGHLIGHTS.map((key) => {\n    return {\n      title: key,\n      handler: {\n        type: \"action\",\n        click: ({ editor, codemirror, root }) => {\n          count = 0;\n          const text = editor.getValue();\n          const searchRegExp = /^---\\n((.|\\n)*?)---/;\n          let newText = \"\";\n          if (searchRegExp.test(text)) {\n            //formatter exit\n            const matchRes = text.match(searchRegExp)?.[1];\n            if (matchRes || matchRes === \"\") {\n              try {\n                let data = (yaml.load(matchRes) || {}) as Record<string, any>;\n                data[HIGHLIGHT_KEY] = key;\n                newText = `---\\n${yaml.dump(data)}---`;\n              } catch (err) {\n                //\n              }\n            }\n            newText = newText + text.replace(searchRegExp, \"\");\n          }\n          //default\n          if (!newText) {\n            newText = `---\\n${HIGHLIGHT_KEY}: ${key}\\n---\\n` + text;\n          }\n          editor.setValue(newText);\n        },\n      },\n    } as BytemdAction;\n  });\n  return {\n    viewerEffect({ file }) {\n      if (!isObject(file)) {\n        return;\n      }\n      style = ((file as Record<string, any>)?.frontmatter as Record<string, any>)?.[HIGHLIGHT_KEY];\n      loadStyle();\n      return () => {\n        $linkEl?.remove();\n      };\n    },\n    actions: [\n      {\n        title: locale.title,\n        icon: icon,\n        handler: {\n          type: \"dropdown\",\n          actions: actionItems,\n        },\n      },\n    ],\n  };\n}\n\nfunction isObject(val: any) {\n  return typeof val === \"object\" && val !== null;\n}\n"]}