{"version":3,"file":"index.js","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":"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","sourcesContent":["import { BytemdPlugin, BytemdViewerContext } from \"bytemd\";\nimport ClipBoard from \"clipboard\";\nimport { visit } from \"unist-util-visit\";\nimport { addClass, hasClass, removeClass } from \"./utils\";\n\ndeclare interface ByteMDPluginCopyCodeOptions {\n  locale?: string;\n  copyText?: string;\n  copySuccess?: (text: string) => void;\n  copyError?: (err: Error) => void;\n  copyRight?: string;\n}\n\n//fold class\nconst HEADER_CLASS = \"code-block-extension-header\";\nconst FOLD_CLASS = \"code-block-extension-fold\";\nconst FOLD_BTN_CLASS = \"code-block-extension-foldBtn\";\nconst COPY_CLASS = \"code-block-extension-copyBtn\";\nconst LANG_CLASS = \"code-block-extension-lang\";\nconst META_CLASS = \"code-block-extension-meta\";\n\nexport default function copyCode(options: ByteMDPluginCopyCodeOptions = {}): BytemdPlugin {\n  const COPY_TEXT = options?.copyText ?? \"复制代码\";\n\n  //click fold button callback\n  function clickFoldBtn(e: Event) {\n    let $el = e.target as HTMLElement;\n    while (!hasClass($el, FOLD_BTN_CLASS)) {\n      $el = $el.parentElement as HTMLElement;\n    }\n    const $codeEl = $el.parentElement?.parentElement?.parentElement?.lastElementChild;\n    if (hasClass($el, FOLD_CLASS)) {\n      removeClass($el, FOLD_CLASS);\n      if ($codeEl) {\n        removeClass($codeEl, FOLD_CLASS);\n      }\n    } else {\n      addClass($el, FOLD_CLASS);\n      if ($codeEl) {\n        addClass($codeEl, FOLD_CLASS);\n      }\n    }\n  }\n  //click copy button callback\n  function clickCopyBtn(e: Event) {\n    let $el = e.target as HTMLElement;\n    while (!hasClass($el, COPY_CLASS)) {\n      $el = $el.parentElement as HTMLElement;\n    }\n    try {\n      const $codeEl = $el?.parentElement?.parentElement?.parentElement?.lastElementChild as HTMLElement;\n      let codeText = \"\";\n      $codeEl.childNodes.forEach((node) => {\n        codeText += node.textContent;\n      });\n      if (options?.copyRight) {\n        codeText += options.copyRight;\n      }\n      const cboard = new ClipBoard($el, {\n        text() {\n          return codeText;\n        },\n      });\n      cboard\n        .on(\"success\", (e) => {\n          options?.copySuccess?.call(null, e.text);\n        })\n        .on(\"error\", (e) => {\n          //\n          options?.copyError?.call(null, new Error(\"copy failed\"));\n        });\n      $el.click();\n      cboard.destroy();\n    } catch (err) {\n      options?.copyError?.call(null, err as Error);\n    }\n  }\n  return {\n    remark: (p) => {\n      p.use(() => (tree, vFile) => {\n        let transformations: any[] = [];\n        visit<import(\"unist\").Node, \"code\">(tree, \"code\", (node: Record<string, any>) => {\n          // get code child html\n          const codeChildren: (Element | Text)[] = (node.data && (node.data.hChildren as (Element | Text)[])) || [\n            {\n              type: \"text\",\n              value: node.value,\n            },\n          ];\n          const codeProperties: any =\n            (node.data && node.data.hProperties) ||\n            (node.lang\n              ? {\n                  className: [\"language-\" + node.lang],\n                }\n              : {});\n          // apply transformation\n          const n = node;\n          n.type = \"code-extra\";\n          if (!n.data) n.data = {};\n          // @ts-ignore\n          const children: Record<string, any>[] = [\n            {\n              type: \"element\",\n              tagName: \"pre\",\n              children: [\n                {\n                  type: \"element\",\n                  tagName: \"div\",\n                  properties: {\n                    className: HEADER_CLASS,\n                  },\n                  children: [\n                    //left\n                    {\n                      type: \"element\",\n                      tagName: \"div\",\n                      properties: {\n                        className: \"code-block-extension-headerLeft\",\n                      },\n                      children: [\n                        {\n                          type: \"element\",\n                          tagName: \"div\",\n                          properties: {\n                            className: FOLD_BTN_CLASS,\n                          },\n                        },\n                        {\n                          type: \"element\",\n                          tagName: \"span\",\n                          properties: {\n                            className: META_CLASS,\n                          },\n                          children: [{ type: \"text\", value: node?.meta ?? \"\" }],\n                        },\n                      ],\n                    },\n                    //right\n                    {\n                      type: \"element\",\n                      tagName: \"div\",\n                      properties: {\n                        className: \"code-block-extension-headerRight\",\n                      },\n                      children: [\n                        {\n                          type: \"element\",\n                          tagName: \"span\",\n                          properties: {\n                            className: LANG_CLASS,\n                          },\n                          children: [\n                            {\n                              type: \"text\",\n                              value: node?.lang ?? \"\",\n                            },\n                          ],\n                        },\n                        {\n                          type: \"element\",\n                          tagName: \"span\",\n                          properties: {\n                            className: COPY_CLASS,\n                            [\"data-clipboard-text\"]: node.value,\n                          },\n                          value: node.value,\n                          children: [{ type: \"text\", value: COPY_TEXT }],\n                        },\n                      ],\n                    },\n                  ],\n                },\n                {\n                  type: \"element\",\n                  tagName: \"code\",\n                  properties: codeProperties,\n                  children: codeChildren,\n                },\n              ],\n            },\n          ];\n          n.data.hName = \"div\";\n          n.data.hProperties = {\n            className: [\"bytemd-code-block\"],\n          };\n          n.data.hChildren = children;\n        });\n        return tree;\n      });\n      return p;\n    },\n    viewerEffect({ markdownBody }): void | (() => void) {\n      const eles = markdownBody.getElementsByClassName(FOLD_BTN_CLASS);\n      Array.from(eles).forEach((ele) => {\n        ele.innerHTML = `<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z\" data-name=\"Down\"></path></svg>`;\n        ele.removeEventListener(\"click\", clickFoldBtn);\n        ele.addEventListener(\"click\", clickFoldBtn);\n      });\n      const copyEles = markdownBody.getElementsByClassName(COPY_CLASS);\n      Array.from(copyEles).forEach((ele) => {\n        ele.removeEventListener(\"click\", clickCopyBtn);\n        ele.addEventListener(\"click\", clickCopyBtn);\n      });\n    },\n  };\n}\n"]}